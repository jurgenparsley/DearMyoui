{{ $gallery := "" }}
{{ $images := where (.Resources.ByType "image") "Params.hidden" "ne" true }}

{{ $imageCount := 0 }}
{{ $albumCount := 0 }}

{{ if .IsPage }}
  {{ $imageCount = len $images }}
{{ else }}
  {{ range where .RegularPagesRecursive "Params.private" "ne" true }}
    {{ $albumCount = add $albumCount 1 }}
    {{ $imageCount = add $imageCount (len (where (.Resources.ByType "image") "Params.hidden" "ne" true)) }}
  {{ end }}
{{ end }}

{{ if or (gt (len $images) 0) (gt $albumCount 0) }}

  {{ $covers := where (.Resources.ByType "image") "Params.cover" "eq" true }}
  {{ $cover := index $covers 0 | default "" }}
  {{ $featured := $cover | default ((.Resources.ByType "image").GetMatch (.Params.featured_image | default "*feature*")) | default (index $images 0) }}

  {{ $thumbnail := "" }}
  {{ $color := "transparent" }}

  {{ if $featured }}
    {{ $thumbnail = $featured.Filter (slice images.AutoOrient (images.Process "fit 600x600")) }}
    {{ $color = index $thumbnail.Colors 0 | default "transparent" }}
  {{ end }}

  {{ $gallery = dict
    "page" $
    "images" $images
    "thumbnail" $thumbnail
    "color" $color
    "albumCount" $albumCount
    "imageCount" $imageCount
  }}

{{ end }}

{{ return $gallery }}
